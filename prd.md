# 📊 Watchtek 보고서 자동화 시스템

> Notion 기반의 일일/주간/월간 업무 보고서 자동 생성 시스템

---

## 📑 목차

1. [시스템 소개](#-시스템-소개)
2. [빠른 시작](#-빠른-시작)
3. [보고서 유형](#-보고서-유형)
4. [주요 기능](#-주요-기능)
5. [설정 가이드](#-설정-가이드)
6. [기술 스택](#-기술-스택)
7. [시스템 아키텍처](#-시스템-아키텍처)
8. [문제 해결](#-문제-해결)

---

## 🎯 시스템 소개

### 무엇을 하는 시스템인가요?

이 시스템은 **Notion에 작성된 업무 데이터를 자동으로 수집하고 정리하여**, 읽기 쉬운 형태의 보고서로 만들어주는 자동화 도구입니다.

### 왜 필요한가요?

- ⏰ **시간 절약**: 매일 반복되는 보고서 작성 시간을 자동화
- 📈 **일관성 유지**: 항상 동일한 형식으로 보고서 생성
- 🎯 **정확성 향상**: 수동 작업으로 인한 실수 방지
- 📊 **데이터 집계**: 주간/월간 공수 및 진행 상황 자동 집계

### 주요 특징

- ✅ **자동 스케줄링**: 설정한 시간에 자동으로 보고서 생성
- ✅ **휴일 감지**: 한국 공휴일과 주말을 자동으로 인식하여 보고서 생성 건너뛰기
- ✅ **다중 담당자 처리**: 여러 명이 함께 작업하는 업무도 정확하게 분리 및 집계
- ✅ **우선순위 정렬**: 멤버별, 그룹별 우선순위에 따라 자동 정렬
- ✅ **공수 집계**: 주간/월간 인원별 공수 자동 계산

---

## 🚀 빠른 시작

### 1단계: 파일 준비

실행 파일(`watchtek-daily-report.exe`)과 `.env` 파일을 같은 폴더에 둡니다.

```
📁 프로젝트 폴더/
  ├── watchtek-daily-report.exe
  └── .env
```

### 2단계: 환경 설정

`.env` 파일을 열어 다음 정보를 입력합니다:

```env
# Notion API 설정
NOTION_API_KEY="secret_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
NOTION_DATABASE_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
NOTION_REPORT_DATABASE_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 실행 시간 설정 (기본값: 매일 오후 5시 45분)
CRON_SCHEDULE="45 17 * * *"
CRON_TIMEZONE="Asia/Seoul"
```

### 3단계: 멤버 설정

`src/config/members.ts` 파일에 팀원 정보를 입력합니다:

```typescript
const memberMap: { [key: string]: { name: string; priority: number } } = {
  'user1@example.com': { name: '홍길동', priority: 1 },
  'user2@example.com': { name: '김철수', priority: 2 },
  // 우선순위 숫자가 작을수록 보고서에서 앞에 표시됩니다
};
export default memberMap;
```

### 4단계: 실행

`watchtek-daily-report.exe` 파일을 더블클릭하여 실행합니다.

✨ 이제 매일 설정한 시간에 자동으로 보고서가 생성됩니다!

---

## 📋 보고서 유형

### 1. 📝 일일 보고서 (Daily Report)

**생성 시점**: 매 평일 (설정한 시간)

**구성 내용**:
- **진행업무**: 오늘 진행한 작업들
- **예정업무**: 내일 예정된 작업들

**자동 분류 로직**:
1. 오늘 날짜가 포함된 작업 → 진행업무
2. 내일 날짜가 포함된 작업 → 예정업무
3. 오늘 종료 예정이지만 완료되지 않은 작업 → 예정업무에도 추가

**정렬 순서**:
```
그룹 정렬 (DCIM프로젝트 우선 → 일반 그룹 → 특수 그룹)
  └─ 서브그룹 정렬 (분석 → 구현 → 기타)
      └─ 작업 정렬 (진행률 높은 순 → 멤버 우선순위 순)
```

**보고서 예시**:

```
📝 큐브 파트 일일업무 보고 (25.01.02)

[진행업무]
1. DCIM 프로젝트
[분석]
- 메뉴 구조 기획 - 대시보드(홍길동, 70%)
- 화면 설계 - 모니터링(김철수, 50%)

[구현]
- API 개발 - 인증 모듈(이영희, 85%)

2. 사이트 지원
[구현]
- [고객사A] 성능운영 자원 매핑(홍길동, 70%)
- [고객사B] CDU 자원 추가 패치 배포(박민수, 10%)

3. 기타
- 출장: 김철수(고객사C, 01/02)
- 회의: 주간 기획 회의(팀 전체)

[예정업무]
1. DCIM 프로젝트
[분석]
- 메뉴 구조 기획 - 대시보드(홍길동)
- 화면 설계 - 알람 관리(김철수)

[구현]
- API 개발 - 알람 모듈(이영희)
```

---

### 2. 🔶 주간 보고서 (Weekly Report)

**생성 시점**: 매주 마지막 평일 (보통 금요일)

**구성 내용**:
- **금주 진행 사항**: 이번 주에 진행한 모든 작업
- **인원별 공수**: 각 멤버가 투입한 시간 집계
- **상세 작업 내역**: 멤버별 작업 및 투입 시간

**자동 집계**:
- 이번 주(월~금)의 모든 일일 보고서 데이터를 수집
- 중복 제거 및 공수 합산
- 멤버별 우선순위에 따라 정렬

**보고서 예시**:

```
🔶 1월 1주차 큐브 파트 주간업무 보고

****금주 진행 사항****
1. DCIM 프로젝트
[분석]
- 메뉴 구조 기획(홍길동, 김철수, 3.5M/H)
- 화면 설계(이영희, 2.0M/H)

[구현]
- API 개발(홍길동, 이영희, 5.0M/H)

2. 사이트 지원
[구현]
- [고객사A] 성능운영 자원 매핑(홍길동, 1.5M/H)

****인원별 공수****
홍길동: 10.0M/H
김철수: 8.5M/H
이영희: 7.0M/H
박민수: 6.0M/H

****인원별 상세 작업****
[홍길동 - 10.0M/H]
- DCIM프로젝트: 8.5M/H
- 사이트 지원: 1.5M/H
```

---

### 3. 📊 월간 보고서 (Monthly Report)

**생성 시점**: 매월 마지막 주의 마지막 평일

**구성 내용**:
- **진행업무**: 이번 달에 시작하여 진행 중인 작업
- **완료업무**: 이번 달에 완료된 작업
- **인원별 공수**: 각 멤버의 월간 투입 시간
- **상세 작업 내역**: 멤버별 월간 작업 및 투입 시간

**자동 집계**:
- 이번 달의 모든 보고서 데이터를 수집
- 완료 여부에 따라 진행업무/완료업무 분류
- 중복 제거 및 공수 합산

**보고서 예시**:

```
📊 2025년 1월 큐브 파트 월간업무 보고

[진행업무]
1. DCIM 프로젝트
[분석]
- 메뉴 구조 기획(홍길동, 김철수, 14.0M/H)
- 화면 설계(이영희, 8.0M/H)

[완료업무]
1. 사이트 지원
[구현]
- [고객사A] 성능운영 자원 매핑(홍길동, 6.0M/H) ✅

****월간 인원별 공수****
홍길동: 80.0M/H
김철수: 75.0M/H
이영희: 70.0M/H
```

---

## 🎨 주요 기능

### 1. 자동 데이터 수집

**Notion 데이터베이스 연동**
- Notion API를 통해 업무 데이터 자동 조회
- 페이지네이션 자동 처리 (대용량 데이터도 문제없음)
- 날짜, 담당자, 그룹, 진행률 등 자동 추출

### 2. 스마트 데이터 처리

**다중 담당자 처리**
- 2명 이상이 함께 작업하는 업무를 자동으로 분리
- 각 담당자별 공수 개별 계산
- '회의', '기타' 같은 공동 작업은 중복 제거

**중복 제거**
- 같은 작업이 여러 날짜에 기록된 경우 자동 병합
- PMS 번호 또는 제목 기준 중복 감지
- 공수는 합산, 진척률은 최신 데이터 유지

**휴일 자동 감지**
- 한국 공휴일 자동 인식 (holiday-kr 라이브러리)
- 주말(토, 일) 자동 인식
- 휴일에는 보고서 생성 건너뛰기

### 3. 자동 정렬 및 분류

**3단계 정렬 시스템**

1. **그룹 정렬**
   ```
   DCIM프로젝트 (최우선)
   → 일반 프로젝트 그룹
   → 사이트 지원, 결함처리, OJT
   → 회의, 기타 (후순위)
   ```

2. **서브그룹 정렬**
   ```
   분석 → 구현 → 기타
   ```

3. **작업 정렬**
   ```
   진행률 높은 순 → 멤버 우선순위 순
   ```

### 4. 공수 자동 집계

**멤버별 공수 계산**
- 주간/월간 각 멤버의 투입 시간 자동 계산
- 그룹별 세부 공수 집계
- 우선순위에 따른 멤버 정렬

**보고서별 공수 합산**
- 동일 작업의 공수 자동 합산
- 다중 담당자 공수 개별 계산

### 5. 자동 보고서 생성

**Notion 페이지 자동 생성**
- 보고서 타입별 아이콘 자동 설정 (📝, 🔶, 📊)
- 날짜 자동 포맷팅 (YY.MM.DD, M월 N주차, YYYY년 M월)
- 태그 자동 부여 (일일보고, 주간보고, 월간보고)

**텍스트 포맷팅**
- 읽기 쉬운 형태로 자동 변환
- 2000자 제한 자동 처리 (Notion 제약)
- 100개 블록 제한 자동 처리 (Notion 제약)

---

## ⚙️ 설정 가이드

### Notion API 키 발급 방법

1. **Notion 통합 생성**
   - https://www.notion.so/my-integrations 접속
   - "New integration" 클릭
   - 통합 이름 입력 (예: "Watchtek Report Bot")
   - "Submit" 클릭

2. **API 키 복사**
   - 생성된 통합에서 "Internal Integration Token" 복사
   - `.env` 파일의 `NOTION_API_KEY`에 붙여넣기

3. **데이터베이스 연결**
   - Notion에서 업무 데이터베이스 페이지 열기
   - 우측 상단 "..." 메뉴 → "Add connections" 클릭
   - 생성한 통합 선택

4. **데이터베이스 ID 확인**
   - 데이터베이스 페이지 URL 복사
   - URL 형식: `https://www.notion.so/{workspace}/{database_id}?v=...`
   - `database_id` 부분을 `.env`에 입력

### CRON 스케줄 설정

CRON 표현식 형식: `분 시 일 월 요일`

**예시**:
```env
# 매일 오후 5시 45분
CRON_SCHEDULE="45 17 * * *"

# 평일(월~금) 오후 6시
CRON_SCHEDULE="0 18 * * 1-5"

# 매주 금요일 오후 5시
CRON_SCHEDULE="0 17 * * 5"
```

### 멤버 우선순위 설정

우선순위 번호가 **작을수록** 보고서에서 **앞쪽**에 표시됩니다.

**권장 우선순위 체계**:
- 1-10: 정규 팀원 (파트장, 시니어 우선)
- 11-20: 계약직/인턴
- 21-30: 외부 협력사

**예시**:
```typescript
const memberMap = {
  'leader@company.com': { name: '팀장', priority: 1 },
  'senior@company.com': { name: '시니어', priority: 2 },
  'junior@company.com': { name: '주니어', priority: 3 },
  'intern@company.com': { name: '인턴', priority: 11 },
};
```

---

## 🛠️ 기술 스택

### 핵심 기술

- **TypeScript** - 타입 안정성이 보장되는 JavaScript
- **Node.js** - JavaScript 런타임 환경
- **Notion API** - Notion 데이터베이스 연동

### 주요 라이브러리

- **@notionhq/client** (v2.2.15) - 공식 Notion API 클라이언트
- **node-cron** (v3.0.3) - 작업 스케줄링
- **holiday-kr** (v0.1.5) - 한국 휴일 감지
- **dotenv** (v16.4.7) - 환경 변수 관리

### 개발 도구

- **pkg** (v5.8.1) - Windows 실행 파일 패키징
- **nodemon** (v3.1.9) - 개발 시 자동 재시작
- **ts-node** (v10.9.2) - TypeScript 직접 실행

---

## 🏗️ 시스템 아키텍처

### 전체 흐름도

```
┌─────────────────┐
│  스케줄러        │  매일 설정 시간에 실행
│  (node-cron)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  휴일 체크       │  공휴일/주말 확인
│  (holiday-kr)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Notion API     │  업무 데이터 조회
│  데이터 조회     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  데이터 처리     │  • 다중 담당자 분리
│                 │  • 중복 제거
│                 │  • 그룹화 및 정렬
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  공수 집계       │  멤버별/그룹별 공수 계산
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  텍스트 변환     │  읽기 쉬운 형태로 포맷팅
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Notion 페이지   │  보고서 페이지 생성
│  생성            │
└─────────────────┘
```

### 서비스 구조

**핵심 서비스**
- `ReportService` - 보고서 생성 프로세스 총괄
- `SchedulerService` - 자동 실행 스케줄 관리

**Notion 연동 서비스**
- `NotionService` - Notion 관련 기능의 통합 인터페이스
- `NotionApiService` - 순수 Notion API 호출만 담당
- `NotionPageService` - Notion 페이지 생성 로직
- `NotionReportBlockService` - 보고서 블록 생성

**데이터 처리 서비스**
- `ReportDataFormatterService` - 데이터 구조 변환 및 포맷팅
- `ReportTextFormatterService` - 데이터를 텍스트로 변환
- `ReportAggregationService` - 공수 집계 및 계산
- `MemberService` - 멤버 정보 관리

### 적용된 디자인 패턴

**Facade Pattern (파사드 패턴)**
- 복잡한 하위 시스템을 단순한 인터페이스로 제공
- 예: `NotionService`가 여러 Notion 서비스를 통합

**Factory Pattern (팩토리 패턴)**
- 보고서 타입에 따라 적절한 생성기 선택
- 예: `ReportPageFactory`가 일일/주간/월간 생성기 선택

**Template Method Pattern (템플릿 메서드 패턴)**
- 공통 흐름은 정의하되, 세부 단계는 하위 클래스가 구현
- 예: `AbstractReportPageCreator`

**Strategy Pattern (전략 패턴)**
- 다양한 정렬 로직을 전략 객체로 캡슐화
- 예: 멤버 우선순위 정렬, 그룹 정렬, 보고서 정렬

---

## ❓ 문제 해결

### 자주 발생하는 문제

**Q1. 보고서가 생성되지 않아요**

✅ **해결 방법**:
1. `.env` 파일이 실행 파일과 같은 폴더에 있는지 확인
2. `NOTION_API_KEY`가 올바른지 확인 ("secret_" 포함)
3. Notion 데이터베이스에 통합이 연결되어 있는지 확인
4. 실행 시간이 휴일(주말/공휴일)이 아닌지 확인

**Q2. 멤버 이름이 이메일로 표시돼요**

✅ **해결 방법**:
1. `src/config/members.ts` 파일 확인
2. 이메일 주소가 Notion 계정과 **정확히 일치**하는지 확인
3. 대소문자, 공백 등 철저히 확인

**Q3. 일부 작업이 보고서에 누락돼요**

✅ **해결 방법**:
1. Notion 데이터베이스에서 해당 작업의 날짜 확인
2. 담당자가 제대로 할당되어 있는지 확인
3. 그룹/서브그룹 속성이 비어있지 않은지 확인

**Q4. 보고서에 "데이터 부족" 그룹이 나타나요**

✅ **원인**: 날짜, 그룹, 서브그룹, 담당자 중 하나 이상이 비어있음

✅ **해결 방법**:
1. Notion에서 해당 작업의 필수 속성 모두 입력
2. 특히 날짜와 담당자는 필수

**Q5. 스케줄이 작동하지 않아요**

✅ **해결 방법**:
1. `CRON_SCHEDULE` 형식이 올바른지 확인
2. 프로그램이 계속 실행 중인지 확인 (백그라운드에서 대기)
3. Windows 작업 스케줄러로 등록하여 자동 시작 설정

### 고급 문제

**Q6. 공수가 정확하지 않아요**

✅ **확인사항**:
- Notion 데이터베이스의 '공수(M/H)' 속성이 숫자 타입인지 확인
- 다중 담당자의 경우 각자 공수가 개별 입력되었는지 확인

**Q7. 그룹 정렬 순서를 변경하고 싶어요**

✅ **방법**:
- `src/utils/sortStrategies.ts`의 `GroupPrioritySortStrategy` 수정
- 특정 그룹을 우선순위 목록에 추가

**Q8. Notion API 오류가 발생해요**

✅ **일반적인 오류**:
- `401 Unauthorized`: API 키가 잘못됨 → `.env` 파일 확인
- `404 Not Found`: 데이터베이스 ID가 잘못됨 → URL 다시 확인
- `403 Forbidden`: 통합이 데이터베이스에 연결되지 않음 → Notion에서 통합 추가
- `429 Too Many Requests`: API 호출 제한 초과 → 잠시 대기 후 재시도

---

## 📞 지원 및 문의

### 로그 확인

프로그램 실행 시 콘솔에 출력되는 로그를 확인하세요:

```
[2025-01-02 17:45:00] 보고서 생성 시작...
[2025-01-02 17:45:02] Notion 데이터 조회 완료 (45건)
[2025-01-02 17:45:03] 데이터 처리 및 정렬 완료
[2025-01-02 17:45:05] 일일 보고서 생성 완료
[2025-01-02 17:45:06] 주간 보고서 생성 완료
```

### 개발자 모드

문제를 진단하려면 디버그 모드로 실행하세요:

```bash
# 개발 환경에서
npm run debug
```

### 추가 자료

- **Notion API 문서**: https://developers.notion.com/
- **CRON 표현식 생성기**: https://crontab.guru/

---

## 📝 마치며

이 시스템은 Watchtek 팀의 업무 효율성을 높이기 위해 설계되었습니다.

**핵심 가치**:
- ⚡ 자동화로 반복 작업 제거
- 📊 정확한 데이터 기반 보고
- 🎯 일관된 품질의 보고서
- 🔄 지속적인 개선 가능

궁금한 점이나 개선 제안이 있으시면 언제든 개발팀에 문의해주세요!

---

*마지막 업데이트: 2025년 1월*
